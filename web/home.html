<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Combo Microservices</title>
</head>
<body>
  <h2>Welcome to the combo microservices server!</h2>
  <p>URLs for this server include:</p>
  <ul>
    <li>%ROOT_URL% - this page</li>
    <li>%TOPICS_URL% - topics in use</li>
    <li>%FACTS_URL% - facts for a given topic; POST to add a fact</li>
    <li>%SUBSCRIPTION_URL% - POST to create a subscription to a topic</li>
    <li>%FROM_SUB_URL% - latest fact from subscription</li>
  </ul>
  <p>
    See the API documentation at
    <a href="http://docs.combo.apiary.io">http://docs.combo.apiary.io</a>
    for further details.
  </p>
  <h3>Chat example</h3>
  <p>
    Publish facts of the form <code>{"who": "joe", "says": "hello"}</code>
    to the topic "chat" to see them below.
  </p> 
  <div id="status" style="font-size:small"></div>
  <div id="chat" style="max-height:100px;overflow:auto;"></div>
<script type='text/javascript'>
  poll = function(retrieval_url) {
    var status_div = document.getElementById('status');
    status_div.innerHTML = 'Starting poll';
    console.log('Starting poll for ' + retrieval_url);
    var poll_xhr = new XMLHttpRequest();
    poll_xhr.timeout = 11000;
    poll_xhr.onreadystatechange = function() { 
      if (poll_xhr.readyState == 4) {
        if (poll_xhr.status == 200) {
          fact = JSON.parse(poll_xhr.responseText);
          who = fact['who'] || 'error';
          says = fact['says'] || 'error';
          var chat_div = document.getElementById('chat');
          chat_div.innerHTML += who + ': ' + says + '<br>';
          chat_div.scrollTop = chat_div.scrollHeight;
          console.log(poll_xhr.responseText); 
        } else {
          console.log('Timed out');
        }
        status_div.innerHTML = 'Finished poll';
        setTimeout(function() {poll(retrieval_url)}, 1000);
      } 
    }
    poll_xhr.open('GET', retrieval_url, true);
    poll_xhr.send(null);
  }
  var sub_xhr = new XMLHttpRequest();
  sub_xhr.onreadystatechange  = function() { 
    if (sub_xhr.readyState == 4) {
      retrieval_url = JSON.parse(sub_xhr.responseText)['retrieval_url'];
      poll(retrieval_url)
    }
  }
  sub_xhr.open('POST', '%SUBSCRIPTION_URL%'.replace('TOPIC', 'chat'), true);
  sub_xhr.send(null);
</script>
</body>
</html>
